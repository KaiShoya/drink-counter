name: Update version

on:
  pull_request:
    branches:
      - main
    types:
      - labeled
  workflow_dispatch:

jobs:
  update_version:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        with:
          version: 10.7.0
          run_install: false

      - name: Determine release label
        id: get_label
        run: |
          echo "labels=${{ toJson(github.event.pull_request.labels.*.name) }}" >> /tmp/labels
          echo "labels=$(cat /tmp/labels)"
          has_patch=$(echo "${{ github.event.pull_request.labels.*.name }}" | grep -q 'release:patch' && echo true || echo false)
          has_minor=$(echo "${{ github.event.pull_request.labels.*.name }}" | grep -q 'release:minor' && echo true || echo false)
          has_major=$(echo "${{ github.event.pull_request.labels.*.name }}" | grep -q 'release:major' && echo true || echo false)
          echo "patch=${has_patch}" >> $GITHUB_OUTPUT
          echo "minor=${has_minor}" >> $GITHUB_OUTPUT
          echo "major=${has_major}" >> $GITHUB_OUTPUT

      - name: Run version bump
        run: |
          set -euo pipefail
          if [ "${{ steps.get_label.outputs.major }}" = "true" ]; then
            pnpm version major
          elif [ "${{ steps.get_label.outputs.minor }}" = "true" ]; then
            pnpm version minor
          elif [ "${{ steps.get_label.outputs.patch }}" = "true" ]; then
            pnpm version patch
          else
            echo 'No release label present, skipping version bump'
            exit 0
          fi
          git add package.json pnpm-lock.yaml
          git commit -m "chore: bump version (release label)"
          git push
