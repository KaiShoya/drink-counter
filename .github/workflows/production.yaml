name: Production - Update version, create release note & check Codacy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # マージされたPRのラベルを取得する
  get-release-label:
    runs-on: ubuntu-latest
    outputs:
      version_type: ${{ steps.get_label.outputs.version_type }}
    steps:
      - name: Get merged PR labels
        id: get_label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # マージコミットに関連するPRを取得
          PR_NUMBER=$(gh api /repos/${{ github.repository }}/commits/${{ github.sha }}/pulls --jq '.[0].number')
          
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No PR found for this commit"
            echo "version_type=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # PRのラベルを取得
          LABELS=$(gh api /repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.labels[].name')
          
          # リリースラベルをチェック (優先順位: major > minor > patch)
          if echo "$LABELS" | grep -q "release:major"; then
            echo "version_type=major" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "release:minor"; then
            echo "version_type=minor" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "release:patch"; then
            echo "version_type=patch" >> $GITHUB_OUTPUT
          else
            echo "version_type=" >> $GITHUB_OUTPUT
          fi

  # バージョンを更新する（リリースラベルがある場合のみ）
  update-version:
    needs: get-release-label
    if: needs.get-release-label.outputs.version_type != ''
    uses: ./.github/workflows/update-version.yaml
    with:
      version_type: ${{ needs.get-release-label.outputs.version_type }}

  # リリースノートを作成する（バージョン更新後）
  create-release-note:
    needs: [get-release-label, update-version]
    if: ${{ !failure() && !cancelled() && needs.get-release-label.outputs.version_type != '' && needs.update-version.result == 'success' }}
    uses: ./.github/workflows/create-release-note.yaml

  codacy:
    uses: ./.github/workflows/codacy-analysis.yaml
    secrets: inherit
